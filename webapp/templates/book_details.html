{% extends 'base.html' %}
{% block title %}Book{% endblock %}
{% block content %}
    {% include 'components/sub_navbar.html' %}
    {% include "components/search.html" %}
    <div id="display-successful-modal" class="absolute z-[100] left-1/2 -translate-x-1/2 -translate-y-1/2 m-auto top-32 w-1/2"></div>
    <div class="my-3.5 mx-5 md:mx-auto max-w-3xl py-12 lg:max-w-[1400px] lg:min-w-[1400px] lg:px-8">
        <div class="max-w-6xl mx-auto">
            <div class="flex flex-col md:flex-row -mx-4 md:gap-6 lg:gap-10">
                <div class="md:flex-1">
                    <div class="h-[460px] border-collapse border border-gray-200 shadow border-opacity-50 rounded px-3 py-6">
                        <img class="w-full h-full object-contain"
                             src="{{ book.img }}"
                             alt="book image">
                    </div>
                </div>
                <div class="md:flex-1 md:px-4 px-10 lg:px-0">
                    <h2 class="text-2xl font-bold text-gray-800 lg:mt-0 mt-8 mb-2">{{ book.title }}</h2>
                    <p class="text-gray-600 text-sm mb-4">
                        by {{ book.author }} (Author)
                    </p>
                    {% include "components/rating.html" %}
                    <div class="my-4">
                        <span class="font-semibold text-gray-700">Price:</span>
                        <span class="text-gray-600">S${{ book.price }}</span>
                    </div>
                    <div class="my-4">
                        <span class="font-semibold text-gray-700">Buy it from</span>
                        <a class="text-blue-500 underline hover:text-blue-600" href="{{ book.url }}" target="_blank">
                            Amazon
                            <i class="fa-solid fa-arrow-up-right-from-square fa-xs"></i>
                        </a>
                    </div>
                    <button class="btn bg-red-400 hover:bg-red-300"
                            hx-trigger="click"
                            hx-post="{{ url_for("accounts.add_to_favourite", isbn=book.isbn) }}"
                            hx-target="#display-successful-modal"
                            hx-swap="innerHTML"
                    >
                        Add to favorite
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                             stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                        </svg>
                    </button>
                    <button class="btn btn-outline btn-info">
                        <a href="#compare-price">Compare price</a>
                    </button>
                    <h2 class="mt-10 font-semibold">Description</h2>
                    <div class="flex -mx-6" x-data="texts()">
                        <template x-for="(text, index) in texts">
                            <div class="max-w-prose mx-auto p-6 relative">
                                <p class="text-sm md:text-[15px] text-justify text-gray-700 line-clamp-4" x-text="text"
                                   x-init="$nextTick(() => { setTruncate(index, $el) })">
                                </p>

                                <!-- dont show read more / read less if the text is not truncated -->
                                <template class="absolute bottom-0 left-0 right-0 px-6 py-4 bg-white w-full"
                                          x-if="truncatable[index]">
                                    <div>
                                        <button class="my-4 underline text-blue-500"
                                                @click="event.target.parentNode.parentNode.querySelector('p').classList.remove('line-clamp-4'); truncated[index] = false;"
                                                x-show="truncated[index]">Read more...
                                        </button>

                                        <button class="my-4 underline text-blue-500"
                                                @click="event.target.parentNode.parentNode.querySelector('p').classList.add('line-clamp-4'); truncated[index] = true;"
                                                x-show="!truncated[index]">Read less...
                                        </button>
                                    </div>
                                </template>
                            </div>
                        </template>
                        <script>
                            function texts() {
                                return {
                                    truncated: [false, false],
                                    truncatable: [false, false],
                                    texts: [
                                        "{{ book.description | safe }}"
                                    ],
                                    setTruncate(index, element) {
                                        if (element.offsetHeight < element.scrollHeight ||
                                            element.offsetWidth < element.scrollWidth) {
                                            // your element has an overflow
                                            // show read more button
                                            this.truncated[index] = true;
                                            this.truncatable[index] = true;
                                        } else {
                                            // your element doesn't have overflow
                                            this.truncated[index] = false;
                                            this.truncatable[index] = false;
                                        }
                                    },
                                    isTruncated(index) {
                                        return true;
                                    }
                                }
                            }
                        </script>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% include "components/compare_price.html" %}

    <div class="mx-auto max-w-3xl py-12 lg:max-w-[1400px] lg:px-8">
        <h1 class="text-lg font-bold pb-4">Customers who viewed this item also viewed</h1>
        <div class="flex flex-row items-center justify-center space-x-4 overflow-hidden w-full">
            <button onclick="scrollCarousel(-5)"
                    class="hidden sm:block bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded focus:outline-none">
                &#8592;
            </button>

            <div id="carousel"
                 class="flex flex-row space-x-1 gap-12 md:gap-0 overflow-x-auto lg:overflow-x-hidden scroll-smooth">
                {% for book in recommend_books %}
                    <div class="flex-none w-1/3 md:w-1/5 ">
                        <a href="{{ url_for('home.book', isbn=book.isbn) }}" class="group">
                            <div class="rounded-md bg-slate-100 w-52 h-64">
                                <img src="{{ book.img }}" alt="image"
                                     class="relative z-10 object-contain w-full h-full object-center pt-2 px-2 md:pt-6">
                            </div>
                            <h3 class="mt-4 text-base text-cyan-700 hover:underline hover:text-cyan-900 hover:cursor-pointer line-clamp-2">{{ book.title }}</h3>
                            <p class="mt-1 text-sm font-medium text-gray-900">by <i>{{ book.author }}</i></p>
                            <p class="mt-1 text-base font-medium text-gray-950">{{ book.price }}</p>
                        </a>
                    </div>
                {% endfor %}
            </div>
            <style>
                ::-webkit-scrollbar {
                    height: 4px; /* height of horizontal scrollbar ‚Üê You're missing this */
                    width: 4px; /* width of vertical scrollbar */
                    border: 1px solid #7b7b7b;
                }
            </style>
            <button onclick="scrollCarousel(5)"
                    class="hidden sm:block bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded focus:outline-none">
                &#8594;
            </button>
        </div>
    </div>

    <script>
        let carousel = document.getElementById('carousel');
        let carouselWidth = carousel.offsetWidth;
        let itemWidth = carousel.children[0].offsetWidth;
        let numItems = carousel.children.length;
        let currentIndex = 0;

        function scrollCarousel(direction) {
            let newIndex = currentIndex + direction;
            if (newIndex < 0) {
                newIndex = 0;
            } else if (newIndex >= numItems - 4) {
                newIndex = numItems - 5;
            }
            carousel.scrollLeft = newIndex * (itemWidth + 3);
            currentIndex = newIndex;
        }
    </script>
    <style>
        #carousel::-webkit-scrollbar {
            display: none;
        }

        #carousel {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
{% endblock %}